import{isMainThread as F}from"node:worker_threads";import{i as _,a as J,m as M}from"../node-features-Dcn4STxq.mjs";import{r as $}from"../register-k5BGI511.mjs";import{fileURLToPath as P,pathToFileURL as A}from"node:url";import{b as D,t as b}from"../index-CteD9jHM.mjs";import{i as T,b as E,r as v}from"../path-utils-BFqhY14w.mjs";import{p as k}from"../client-Cg7nS93t.mjs";import g from"node:path";import{parseTsconfig as I,getTsconfig as L,createFilesMatcher as C,createPathsMatcher as G}from"get-tsconfig";import O from"node:fs";import"node:module";import"esbuild";import"node:crypto";import"node:os";import"../temporary-directory-CwHp0_NW.mjs";import"node:net";import"../get-pipe-path-CmcG6VNd.mjs";const p={active:!0},W=async t=>{if(!t)throw new Error(`tsx must be loaded with --import instead of --loader
The --loader flag was deprecated in Node v20.6.0 and v18.19.0`);p.namespace=t.namespace,t.port&&(p.port=t.port,t.port.on("message",s=>{s==="deactivate"&&(p.active=!1,t.port.postMessage({type:"deactivated"}))}))},q=()=>"process.setSourceMapsEnabled(true);",f=new Map,H=async t=>{if(f.has(t))return f.get(t);if(!await O.promises.access(t).then(()=>!0,()=>!1)){f.set(t,void 0);return}const a=await O.promises.readFile(t,"utf8");try{const e=JSON.parse(a);return f.set(t,e),e}catch{throw new Error(`Error parsing: ${t}`)}},Q=async t=>{let s=new URL("package.json",t);for(;!s.pathname.endsWith("/node_modules/package.json");){const a=P(s),e=await H(a);if(e)return e;const n=s;if(s=new URL("../package.json",s),s.pathname===n.pathname)break}},X=async t=>(await Q(t))?.type??"commonjs",m=process.env.TSX_TSCONFIG_PATH?{path:g.resolve(process.env.TSX_TSCONFIG_PATH),config:I(process.env.TSX_TSCONFIG_PATH)}:L(),K=m&&C(m),N=m&&G(m),z=m?.config.compilerOptions?.allowJs??!1,B="file://",l=/\.([cm]?ts|[tj]sx)($|\?)/,x=/\.json(?:$|\?)/,V=t=>{const s=g.extname(t.split("?")[0]);if(s===".json")return"json";if(s===".mjs"||s===".mts")return"module";if(s===".cjs"||s===".cts")return"commonjs"},Y=t=>{const s=V(t);if(s)return s;if(l.test(t))return X(t)},d="tsx-namespace=",u=t=>{const s=t.indexOf(d);if(s===-1)return;const a=t[s-1];if(a!=="?"&&a!=="&")return;const e=s+d.length,n=t.indexOf("&",e);return n===-1?t.slice(e):t.slice(e,n)},h=_(J)?"importAttributes":"importAssertions",Z=async(t,s,a)=>{if(!p.active||p.namespace&&p.namespace!==u(t))return a(t,s);if(p.port){const o=new URL(t);o.searchParams.delete("tsx-namespace"),p.port.postMessage({type:"load",url:o.toString()})}k.send&&k.send({type:"dependency",path:t}),x.test(t)&&(s[h]||(s[h]={}),s[h].type="json");const e=await a(t,s);if(!e.source)return e;const n=t.startsWith("file://")?P(t):t,r=e.source.toString();if(e.format==="json"||l.test(t)){const o=await D(r,n,{tsconfigRaw:K?.(n)});return{format:"module",source:T(o)}}if(e.format==="module"){const o=b(n,r);o&&(e.source=T(o))}return e},R=/\/(?:$|\?)/,y=async(t,s,a)=>{const e=await t(s,a);return!e.format&&e.url.startsWith(B)&&(e.format=await Y(e.url)),e},tt=[".js",".json",".ts",".tsx",".jsx"],w=async(t,s,a)=>{const[e,n]=t.split("?");let r;for(const o of tt)try{return await y(a,e+o+(n?`?${n}`:""),s)}catch(c){if(r===void 0&&c instanceof Error){const{message:i}=c;c.message=c.message.replace(`${o}'`,"'"),c.stack=c.stack.replace(i,c.message),r=c}}throw r},U=async(t,s,a)=>{const e=R.test(t),n=e?"index":"/index",[r,o]=t.split("?");try{return await w(r+n+(o?`?${o}`:""),s,a)}catch(c){if(!e)try{return await w(t,s,a)}catch{}const i=c,{message:S}=i;throw i.message=i.message.replace(`${n.replace("/",g.sep)}'`,"'"),i.stack=i.stack.replace(S,i.message),i}},j=async(t,s,a,e)=>{if(!p.active)return a(t,s);const n=s.parentURL&&u(s.parentURL);if(E(t)){let r=u(t);if(n&&!r&&(r=n,t+=`${t.includes("?")?"&":"?"}${d}${n}`),p.namespace&&p.namespace!==r)return a(t,s);if(R.test(t))return await U(t,s,a)}else if(N&&!s.parentURL?.includes("/node_modules/")){const r=N(t);for(const o of r)try{return await j(A(o).toString(),s,a)}catch{}}if(l.test(s.parentURL)||z){const r=v(t);if(r)for(const o of r)try{return await y(a,o,s)}catch(c){const{code:i}=c;if(i!=="ERR_MODULE_NOT_FOUND"&&i!=="ERR_PACKAGE_PATH_NOT_EXPORTED")throw c}}try{const r=await y(a,t,s);if(E(r.url)){const o=u(r.url);n&&!o&&(r.url+=`${r.url.includes("?")?"&":"?"}${d}${n}`)}return r}catch(r){if(r instanceof Error&&!e){const{code:o}=r;if(o==="ERR_UNSUPPORTED_DIR_IMPORT")try{return await U(t,s,a)}catch(c){if(c.code!=="ERR_PACKAGE_IMPORT_NOT_DEFINED")throw c}if(o==="ERR_MODULE_NOT_FOUND")try{return await w(t,s,a)}catch{}}throw r}};_(M)&&F&&$();export{q as globalPreload,W as initialize,Z as load,j as resolve};
